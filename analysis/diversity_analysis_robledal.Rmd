---
title: "Analisis diversidad aves robledal"
date: "`r Sys.Date()`"
output: rmdformats::robobook
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r, echo=FALSE}
library(tidyverse)
library(here)
library(DT)
library(ggpubr)
library(vegan)
library(ggplot2)
```

## Preparar datos 
- Quitamos los que no son dispersantes
- Datos desde 2010 hasta 2017 

```{r}
# read data
transectos_qp <- read_csv(here::here("/data/transectos_qp.csv")) %>% 
  mutate(area_ha = (100*longitud)/10000) %>% dplyr::select(-id)

df <- read_csv(here::here("/data/dispersantes_qp.csv")) %>% inner_join(transectos_qp) %>% 
  mutate(loc = case_when(
    str_detect(nombre, "Cáñar") ~ "CAN", 
    str_detect(nombre, "Dílar") ~ "DIL",
    str_detect(nombre, "Hornillo") ~ "GEN",
    str_detect(nombre, "Camarate") ~ "CAM"
  )) 

# Quitamos los no dispersantes 
# Datos desde 2010 

disp <- df %>% 
  filter(!specie %in% c("Valor nulo", "Accipiter gentilis", "Accipiter nisus", "Falco tinnunculus", "Athene noctua", "Alectoris rufa")) %>% 
  filter(year>2009) %>% 
  filter(year < 2018)
```


## Análisis de la diversidad por sitio

- Calculamos la diversidad por sitio para cada año
- Analizamos si existen diferencias para la diversidad entre sitios (Kruskal-Wallis) y hacemos comparaciones entre sitios (Dunn test)

```{r}
ab <- disp %>% 
  mutate(sp = str_replace(specie, " ", ".")) %>% 
  group_by(loc, sp, year, area_ha) %>% 
  summarise(abundancia = sum(numero)) %>% 
  dplyr::select(loc, abundancia)

density <- ab %>% 
  pivot_wider(names_from = year, values_from=abundancia, names_prefix = "y", values_fill = 0)


years <- c("y2010","y2011","y2012","y2013","y2014","y2015","y2016","y2017")

out_h <- data.frame() 

for (y in years){ 
  
  vars <- c("sp", "loc", y) 

  aux <- density %>% dplyr::select(all_of(vars)) %>% 
    pivot_wider(names_from = sp, values_from = y, values_fill = 0) %>% 
    column_to_rownames(var = "loc")
  
  h <- vegan::diversity(aux) 
  h$year <- y
  out_h <- rbind(out_h, h)
  
}


diversidad <- out_h %>% pivot_longer(!year, names_to = "loc") %>% 
  mutate(year = as.numeric(substring(year,2)))

plot_diversidad <- ggboxplot(diversidad, x = "loc", y = "value") 

my_comparisons <- list( c("CAM", "CAN"), c("CAM", "DIL"), c("CAM", "GEN"), 
                        c("CAN", "DIL"), c("CAN", "GEN"), c("DIL", "GEN"))

plot_diversidad + stat_compare_means(comparisons = my_comparisons) +
  stat_compare_means(label.y=3)
```

## Análisis de la abundancia total

- Calculamos la abundancia total (ind/10 ha) por sitio para cada año
- Analizamos si existen diferencias para la abundancia total entre sitios (Kruskal-Wallis) y hacemos comparaciones entre sitios (Dunn test)

```{r}
areas <- df %>% dplyr::select(loc, area_ha) %>% unique()

aux_density <- density %>% 
  pivot_longer(y2010:y2017, names_to = "year") %>% 
  inner_join(areas) 

density_ha <- aux_density %>% 
  mutate(ab_ha = (value / area_ha*10))

densidad_total <- density_ha %>% 
  group_by(loc, year) %>% 
  summarise(ab_ha_total = sum(ab_ha))

p <- ggboxplot(densidad_total, x = "loc", y = "ab_ha_total") 

my_comparisons <- list( c("CAM", "CAN"), c("CAM", "DIL"), c("CAM", "GEN"), 
                        c("CAN", "DIL"), c("CAN", "GEN"), c("DIL", "GEN"))

p + stat_compare_means(comparisons = my_comparisons) +
  stat_compare_means(label.y=400)

```

## Riqueza total
```{r}
# Riqueza total 
riq <- aux_density %>% 
  dplyr::select(sp, loc) %>% unique() %>% group_by(loc) %>% count()

knitr::kable(riq)
```

## Indice de dominancia de Simpson 

- Calculamos lel índice de dominancia de simpson por sitio para cada año
- Analizamos si existen diferencias para este indice entre sitios (Kruskal-Wallis) y hacemos comparaciones entre sitios (Dunn test)

```{r}
years <- c("y2010","y2011","y2012","y2013","y2014","y2015","y2016","y2017")

out_s <- data.frame() 

for (y in years){ 
  
  vars <- c("sp", "loc", y) 

  aux <- density %>% dplyr::select(all_of(vars)) %>% 
    pivot_wider(names_from = sp, values_from = y, values_fill = 0) %>% 
    column_to_rownames(var = "loc")
  
  s <- 1 - vegan::diversity(aux, "simpson") 
  s$year <- y
  out_s <- rbind(out_s, s)
  
}

simpson <- out_s %>% pivot_longer(!year, names_to = "loc") %>% 
  mutate(year = as.numeric(substring(year,2)))

plot_simpson <- ggboxplot(simpson, x = "loc", y = "value") 

my_comparisons <- list( c("CAM", "CAN"), c("CAM", "DIL"), c("CAM", "GEN"), 
                        c("CAN", "DIL"), c("CAN", "GEN"), c("DIL", "GEN"))

plot_simpson + stat_compare_means(comparisons = my_comparisons) +
  stat_compare_means(label.y=.6)
```


## Indices de disimilaridad

- Computamos el índice de disimilaridad de Jaccard (ja) y de Morisita-Horn (ma). 


```{r}

ja_aux <- density %>% pivot_longer(y2010:y2017, names_to="ab") %>% 
  group_by(sp, loc) %>% 
  summarise(ab_avg = mean(value)) %>% 
  pivot_wider(names_from = sp, values_from = ab_avg, values_fill = 0) %>% 
    column_to_rownames(var = "loc")
  
  
jaccard  <- vegdist(ja_aux)

morisita.horn <- vegdist(ja_aux, "horn")


df_ja <- as.matrix(jaccard) %>% 
  as.data.frame() %>% 
  rename_all(function(x) paste0(x, "_ja")) %>% 
  rownames_to_column(var="loc") 


df_mori <- as.matrix(morisita.horn) %>% 
  as.data.frame() %>% 
  rename_all(function(x) paste0(x, "_mh")) %>% 
  rownames_to_column(var="loc")

dis <- df_ja %>% inner_join(df_mori)


dis_aux <- dis %>% 
  pivot_longer(!loc, names_to = "variable") %>% 
  filter(value != 0) %>% 
  mutate(
    loc2 = substring(variable, 1,3), 
    variable = substring(variable, 5) 
  )


dis_aux %>% ggplot(aes(x=loc2, y=value, fill=variable)) +
  geom_bar(stat="identity", position = "dodge") + 
  facet_wrap(~loc) +
  theme_bw()
```


## NMDS 
```{r, echo=FALSE, eval=FALSE}

fit <- cmdscale(vegdist(ja_aux,"bray"), eig = TRUE, k = 2)
plot(fit)




aux_nmds <- density %>% pivot_longer(y2010:y2017, names_to="ab") %>% 
  group_by(sp, loc) %>% 
  summarise(ab_avg = sum(value)) %>% 
  pivot_wider(names_from = sp, values_from = ab_avg, values_fill = 0) %>% 
    column_to_rownames(var = "loc")

set.seed(1234)
m1 <- metaMDS(aux_nmds, distance = "bray", k=2)

plot(cmdscale(vegdist(ja_aux,"bray"))) 
     col=as.numeric(myfungi$Habitat))



```




